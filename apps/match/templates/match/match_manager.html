{# apps/match/templates/match/match_manager.html #}
{% extends "base.html" %}
{% from "_macros.html" import render_pagination %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">매칭 관리 페이지</h2>

    <ul class="nav nav-tabs" id="matchTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a 
                class="nav-link {% if request.args.get('search_type', 'new') == 'new' %}active{% endif %}" 
                id="new-match-tab"
                href="{{ url_for('match.match_manager', search_type='new') }}"
                role="tab"
                aria-controls="new-match"
                aria-selected="true"
            >
                신규 매칭 ({{ new_match_pagination.total }})
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a 
                class="nav-link {% if request.args.get('search_type') == 'manage' %}active{% endif %}" 
                id="manage-match-tab"
                href="{{ url_for('match.match_manager', search_type='manage', status='IN_PROGRESS') }}"
                role="tab"
                aria-controls="manage-match"
                aria-selected="false"
            >
                매칭 관리 ({{ pagination.total }})
            </a>
        </li>
    </ul>
    <div class="tab-content" id="matchTabsContent">
        <!-- 신규 매칭 탭 -->
        <div class="tab-pane fade {% if request.args.get('search_type', 'new') == 'new' %}show active{% endif %}" id="new-match" role="tabpanel" aria-labelledby="new-match-tab">
            <div class="card my-3">
                <div class="card-header">
                    <h5 class="mb-0">신규 매칭 사용자 검색</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{{ url_for('match.match_manager') }}" class="row g-2 align-items-end">
                        {{ new_match_form.csrf_token }}
                        <input type="hidden" name="search_type" value="new">
                        <div class="col-12 col-md-4 col-lg-4">
                            {{ new_match_form.keyword.label(class="form-label visually-hidden") }}
                            {{ new_match_form.keyword(class="form-control form-control-sm", type="search", placeholder="ID, 사용자명, 이메일 등") }}
                        </div>
                        <div class="col-12 col-md-2 col-lg-2">
                            {{ new_match_form.start_date.label(class="form-label visually-hidden") }}
                            {{ new_match_form.start_date(class="form-control form-control-sm", type="date", placeholder="시작일") }}
                        </div>
                        <div class="col-auto d-flex align-items-center">
                            <span class="form-label mb-0">~</span>
                        </div>
                        <div class="col-12 col-md-2 col-lg-2">
                            {{ new_match_form.end_date.label(class="form-label visually-hidden") }}
                            {{ new_match_form.end_date(class="form-control form-control-sm", type="date", placeholder="종료일") }}
                        </div>
                        <div class="col-12 col-md-1 d-grid col-lg-1">
                            <button type="submit" name="search_submit" class="btn btn-primary btn-sm">검색</button>
                        </div>
                    </form>
                </div>
            </div>
            <form method="POST" action="{{ url_for('match.create_new_match') }}">
                {{ new_match_form.csrf_token }}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">매칭 대기 사용자 목록 ({{ new_match_pagination.total }}명)</h5>
                    <div class="d-flex align-items-center gap-2">
                        {{ new_match_form.expert_id(class="form-select form-select-sm") }}
                        <button type="submit" name="assign_submit" class="btn btn-success btn-sm" style="width: auto; min-width: 100px;">매칭 생성</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="checkAllUsers"></th>
                                <th>ID</th>
                                <th>이메일</th>
                                <th>사용자 타입</th>
                                <th>매치 상태</th>
                                <th>등록일자</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users_to_match %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="user_ids" value="{{ user.id }}" class="user-checkbox"></td>
                                <td>{{ user.id }}</td>
                                <td>{{ user.email }}</td>
                                <td>{{ user.user_type.value }}</td>
                                <td>{{ user.match_status.value }}</td>
                                <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center">매칭 대기 중인 사용자가 없습니다.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if new_match_pagination.pages > 1 %}
<div class="card-footer">
    {{ render_pagination(new_match_pagination, 'match.match_manager', filtered_args_new, 'new_page') }}
</div>
                {% endif %}
            </form></div>
        <!-- 기존 매칭 관리 탭 -->
        <div class="tab-pane fade {% if request.args.get('search_type') == 'manage' %}show active{% endif %}" id="manage-match" role="tabpanel" aria-labelledby="manage-match-tab">
            <div class="card my-3">
                <div class="card-header">
                    <h5 class="mb-0">매칭 기록 검색</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{{ url_for('match.match_manager') }}" class="row g-2 align-items-end">
                        {{ match_search_form.csrf_token }}
                        <input type="hidden" name="search_type" value="manage">
                        <div class="col-12 col-md-3 col-lg-3">
                            {{ match_search_form.keyword.label(class="form-label visually-hidden") }}
                            {{ match_search_form.keyword(class="form-control form-control-sm", type="search", placeholder="ID, 사용자/전문가 ID, 이메일 등") }}
                        </div>
                        <div class="col-12 col-md-2 col-lg-2">
                            {{ match_search_form.status.label(class="form-label visually-hidden") }}
                            {{ match_search_form.status(class="form-select form-select-sm") }}
                        </div>
                        <div class="col-12 col-md-2 col-lg-2">
                            {{ match_search_form.start_date.label(class="form-label visually-hidden") }}
                            {{ match_search_form.start_date(class="form-control form-control-sm", type="date", placeholder="시작일") }}
                        </div>
                        <div class="col-auto d-flex align-items-center">
                            <span class="form-label mb-0">~</span>
                        </div>
                        <div class="col-12 col-md-2 col-lg-2">
                            {{ match_search_form.end_date.label(class="form-label visually-hidden") }}
                            {{ match_search_form.end_date(class="form-control form-control-sm", type="date", placeholder="종료일") }}
                        </div>
                        <div class="col-12 col-md-1 d-grid col-lg-1">
                            <button type="submit" name="search_submit" class="btn btn-primary btn-sm">검색</button>
                        </div>
                    </form>
                </div>
            </div>
            <form method="POST" action="{{ url_for('match.batch_update_matches') }}">
                {{ match_search_form.csrf_token }}
                <input type="hidden" name="keyword" value="{{ request.args.get('keyword', '') }}">
                <input type="hidden" name="status" value="{{ request.args.get('status', status_query) }}">
                <input type="hidden" name="start_date" value="{{ request.args.get('start_date', '') }}">
                <input type="hidden" name="end_date" value="{{ request.args.get('end_date', '') }}">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">전체 매칭 기록</h5>
                    <div class="d-flex align-items-center gap-2">
                        {{ match_search_form.batch_expert_id(class="form-select form-select-sm") }}
                        <button type="submit" name="batch_assign_submit" class="btn btn-warning btn-sm" style="width: auto; min-width: 100px;">일괄 할당</button>
                        <button type="submit" name="batch_cancel_submit" class="btn btn-danger btn-sm" style="width: auto; min-width: 100px;">일괄 취소</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="checkAllMatches"></th>
                                <th>매칭 ID</th><th>사용자</th><th>전문가</th><th>상태</th><th>매칭일</th>
                                <th>종료일</th>
                            </tr></thead>
                        <tbody>
                            {% for match in matches_history %}
                            <tr>
                                <td>
                                    {% if match.status.name == 'IN_PROGRESS' %}
                                    <input type="checkbox" name="match_ids" value="{{ match.id }}" class="match-checkbox">
                                    {% endif %}
                                </td>
                                <td>{{ match.id }}</td>
                                <td><a href="#">{{ match.user.email }}</a></td>
                                <td><a href="#">{{ match.expert.email if match.expert else 'N/A' }}</a></td>
                                <td>{{ match.status.value }}</td>
                                <td>{{ match.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ match.closed_at.strftime('%Y-%m-%d %H:%M') if match.closed_at else 'N/A' }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center">조건에 맞는 매칭 기록이 없습니다.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>
            {% if pagination %}
<div class="card-footer">
    {{ render_pagination(pagination, 'match.match_manager', filtered_args, 'page') }}
</div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // 체크박스 전체 선택/해제 기능
    document.getElementById('checkAllUsers').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('#new-match .user-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });
    document.getElementById('checkAllMatches').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('#manage-match .match-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });
</script>
{% endblock %}
